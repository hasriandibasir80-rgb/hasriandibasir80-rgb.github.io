<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pembukuan Voucher - Akuntansi</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f9f9f9;
      color: #333;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    .section {
      background: white;
      padding: 15px;
      margin: 12px 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }
    .section.active {
      display: block;
    }
    h2, h3 { margin-top: 0; }
    input, select, button, textarea {
      margin: 6px 4px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 16px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      margin: 8px auto;
      display: block;
      border-radius: 8px;
    }
    button:hover { opacity: 0.9; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }

    .menu-btn {
      padding: 14px;
      font-weight: bold;
      font-size: 18px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    }
    .menu-btn:hover {
      transform: translateY(-2px);
    }
    .btn-red { background: #dc3545; }
    .btn-yellow { background: #ffc107; color: #212529; }
    .btn-green { background: #28a745; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f1f1f1; }
    #loginScreen {
      max-width: 320px;
      margin: 60px auto;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #menuUtama {
      display: none;
      text-align: center;
    }
    #modalAgen {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 90%;
      max-width: 400px;
    }
    .readonly-cell {
      background: #f5f5f5;
      color: #666;
    }
    .catatan-item {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    .catatan-header {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 4px;
    }
    .catatan-text {
      white-space: pre-wrap;
    }
    .mode-view {
      display: none;
    }
    .mode-view.active {
      display: block;
    }
    @media (max-width: 600px) {
      .section { padding: 12px; }
      input, select, button { font-size: 14px; padding: 6px; }
      button.menu-btn { font-size: 16px; padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginScreen">
      <h2>Login Pembukuan</h2>
      <input type="text" id="username" placeholder="Username" autocomplete="off" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Masuk</button>
      <p id="loginError" style="color: red; margin-top: 8px;"></p>
    </div>

    <!-- MENU UTAMA SETELAH LOGIN -->
    <div id="menuUtama"></div>

    <!-- MAIN APP -->
    <div id="app" style="display: none;">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="headerTitle">Pembukuan Voucher</h2>
        <button onclick="logout()" style="width: auto; padding: 6px 12px; font-size: 14px;">Logout</button>
      </header>

      <!-- BERANDA BUTTON -->
      <div class="section active" id="sectionBeranda">
        <button onclick="tampilkanMenu()">Beranda</button>
      </div>

      <!-- PERIODE -->
      <div class="section" id="sectionPeriode">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <label><strong>Periode:</strong></label>
        <select id="periodeSelect" onchange="loadPeriode()"></select>
        <button id="btnSetActive" onclick="setActivePeriode()" style="display:none;">Tetapkan sebagai Aktif</button>
        <button id="btnTambahPeriode" onclick="tambahPeriode()" style="display:none;">+ Tambah Periode</button>
        <button id="btnBackup" onclick="backupData()">Backup</button>
      </div>

      <!-- TRANSAKSI -->
      <div class="section" id="sectionTransaksi">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <h3>Transaksi</h3>
        <div>
          <h4>Pengambilan Voucher</h4>
          <select id="agenAmbil"><option value="">-- Pilih Agen --</option></select>
          <input type="date" id="tglAmbil" />
          <input type="number" id="v3Ambil" placeholder="Jumlah V3" min="0" />
          <input type="number" id="v5Ambil" placeholder="Jumlah V5" min="0" />
          <button onclick="simpanTransaksi('ambil')">Simpan Pengambilan</button>
        </div>
        <div style="margin-top: 15px;">
          <h4>Penyetoran</h4>
          <select id="agenSetor"><option value="">-- Pilih Agen --</option></select>
          <input type="date" id="tglSetor" />
          <input type="number" id="nominalSetor" placeholder="Nominal (Rp)" min="0" />
          <button onclick="simpanTransaksi('setor')">Simpan Penyetoran</button>
        </div>
        <div style="margin-top: 15px;">
          <h4>Transfer ke Global</h4>
          <input type="date" id="tglTf" />
          <input type="number" id="jumlahTf" placeholder="Jumlah Transfer (Rp)" min="0" />
          <button onclick="simpanTransaksi('tf')">Simpan TF</button>
        </div>
      </div>

      <!-- RIWAYAT TRANSAKSI (GABUNGAN) -->
      <div class="section" id="sectionRiwayat">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <h3>Riwayat Transaksi Detail</h3>
        <table>
          <thead>
            <tr>
              <th>Tanggal</th><th>Agen</th><th>Pengambilan</th><th>Penyetoran</th><th>V3</th><th>V5</th><th>Nominal</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody id="tbodyRiwayat"></tbody>
          <tfoot>
            <tr>
              <td colspan="6"><strong>Total Keseluruhan</strong></td>
              <td id="totalAmbilFooter">Rp. 0</td>
              <td id="totalSetorFooter">Rp. 0</td>
            </tr>
          </tfoot>
        </table>

        <h3 style="margin-top: 25px;">Rekap per Agen</h3>
        <table>
          <thead>
            <tr><th>Nama Agen</th><th>Total Pengambilan (Rp)</th><th>Total Setoran (Rp)</th><th>Sisa Utang (Rp)</th></tr>
          </thead>
          <tbody id="tbodyRekapAgen"></tbody>
        </table>
      </div>

      <!-- LAPORAN -->
      <div class="section" id="sectionLaporan">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <h3>Rekap Keseluruhan</h3>
        <table>
          <tr><td>1. Total stok awal</td><td id="rek1">0</td></tr>
          <tr><td>2. Total yang belum diterima</td><td id="rek2">0</td></tr>
          <tr><td>3. Total yang sudah diterima dari agen</td><td id="rek3">0</td></tr>
          <tr><td>4. Total yang akan ditransfer ke Global</td><td id="rek4">0</td></tr>
          <tr><td>5. Total yang sudah ditransfer ke Global</td><td id="rek5">0</td></tr>
          <tr><td>6. Total sisa yang belum ditransfer</td><td id="rek6">0</td></tr>
          <tr><td>7. Total dana dalam bentuk barang</td><td id="rek7">0</td></tr>
        </table>
      </div>

      <!-- NOTA -->
      <div class="section" id="sectionNota">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <h3>Catatan Penting</h3>

        <!-- Pilihan Awal -->
        <div id="pilihanNota">
          <button onclick="tampilkanModeBaca()">1. Baca Catatan Penting</button>
          <button onclick="tampilkanModeBuat()">2. Tulis Catatan Penting Baru</button>
        </div>

        <!-- Mode Baca: Daftar Catatan -->
        <div id="modeBaca" style="display:none;">
          <button onclick="kembaliKePilihanNota()">‚Üê Kembali ke Pilihan</button>
          <h4>Catatan Tersimpan (Periode: <span id="periodeDiNota">-</span>)</h4>
          <div id="daftarCatatan">
            <p>Memuat catatan...</p>
          </div>
        </div>

        <!-- Mode Buat: Form Input -->
        <div id="modeBuat" style="display:none;">
          <button onclick="kembaliKePilihanNota()">‚Üê Kembali ke Pilihan</button>
          <h4>Tulis Catatan Baru</h4>
          <textarea id="inputCatatanBaru" rows="4" placeholder="Ketik catatan penting di sini..." style="width:100%;"></textarea>
          <button onclick="simpanCatatanBaru()">Simpan</button>
        </div>
      </div>

      <!-- STOK -->
      <div class="section" id="sectionStok">
        <button onclick="kembaliKeBeranda()">‚Üê Kembali ke Beranda</button>
        <h3>Stok Voucher</h3>
        <table>
          <tr><td>Stok Awal V3</td><td id="cellStokV3">0</td></tr>
          <tr><td>Stok Awal V5</td><td id="cellStokV5">0</td></tr>
          <tr><td>Stok yang telah di-drop V3</td><td id="dropV3">0</td></tr>
          <tr><td>Stok yang telah di-drop V5</td><td id="dropV5">0</td></tr>
          <tr><td><strong>Sisa Stok V3</strong></td><td id="sisaV3">0</td></tr>
          <tr><td><strong>Sisa Stok V5</strong></td><td id="sisaV5">0</td></tr>
        </table>
        <button id="btnSimpanStok" onclick="simpanStok()" style="display:none;">Simpan Stok Awal</button>
      </div>

      <!-- MODAL TAMBAH/EDIT AGEN -->
      <div id="modalAgen">
        <h3>Tambah/Edit Agen</h3>
        <input type="text" id="modalId" placeholder="ID (001)" maxlength="3" />
        <input type="text" id="modalNama" placeholder="Nama Agen" />
        <button onclick="simpanAgen()">Simpan</button>
        <button onclick="tutupModal()">Batal</button>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
      // === FIREBASE CONFIG ===
      const firebaseConfig = {
        apiKey: "AIzaSyC45P_1xbNL8zi3e0aS4kHkIGvRvGEAmwM",
        authDomain: "takkoandi-8e99e.firebaseapp.com",
        databaseURL: "https://takkoandi-8e99e-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "takkoandi-8e99e",
        storageBucket: "takkoandi-8e99e.firebasestorage.app",
        messagingSenderId: "117264025083",
        appId: "1:117264025083:web:8102fe737f7783e1b7b75e"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const HARGA_V3_AGEN = 2550;
      const HARGA_V5_AGEN = 4250;
      const HARGA_V3_GLOBAL = 2400;
      const HARGA_V5_GLOBAL = 4000;
      const AGEN_DEFAULT = {
        "001": "nani", "002": "rostini", "003": "mila", "004": "mira", "005": "mama arham",
        "006": "jusrawira", "007": "putri", "008": "ardila", "009": "sulaeman", "010": "ira",
        "011": "jusriadi", "012": "ricky", "013": "risman", "014": "afzal", "015": "rika",
        "016": "ayu", "017": "hasna", "018": "asnita", "019": "nisma", "020": "ennar",
        "021": "nailah", "022": "ady", "023": "radiah", "024": "bau wawan",: "025": "miranti itha",
      };
      let currentUser = null;
      let currentPeriode = null;
      let globalActivePeriode = null;
      let agenCache = {};
      let transaksiListener = null;

      // === NAVIGASI BARU ===
      function tampilkanMenu() {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        const menu = document.getElementById("menuUtama");
        menu.innerHTML = `
          <button class="menu-btn btn-red" onclick="bukaSection('sectionPeriode')">1. Periode</button>
          <button class="menu-btn btn-red" onclick="bukaSection('sectionTransaksi')">2. Transaksi</button>
          <button class="menu-btn btn-yellow" onclick="bukaSection('sectionRiwayat')">3. Riwayat Transaksi</button>
          <button class="menu-btn btn-yellow" onclick="bukaSection('sectionLaporan')">4. Laporan</button>
          <button class="menu-btn btn-green" onclick="bukaSection('sectionNota')">5. Nota</button>
          <button class="menu-btn btn-green" onclick="bukaSection('sectionStok')">6. Stok</button>
        `;
        menu.style.display = "block";
        document.getElementById("app").style.display = "none";
      }

      function kembaliKeBeranda() {
        document.getElementById("menuUtama").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById("sectionBeranda").classList.add('active');
      }

      function bukaSection(id) {
        document.getElementById("menuUtama").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === "sectionNota") {
          tampilkanPilihanAwal();
        }
      }

      function tampilkanPilihanAwal() {
        document.getElementById('pilihanNota').style.display = 'block';
        document.getElementById('modeBaca').style.display = 'none';
        document.getElementById('modeBuat').style.display = 'none';
      }

      function tampilkanModeBaca() {
        document.getElementById('pilihanNota').style.display = 'none';
        document.getElementById('modeBuat').style.display = 'none';
        document.getElementById('modeBaca').style.display = 'block';
        document.getElementById('periodeDiNota').textContent = globalActivePeriode || 'Tidak ada';
        loadCatatan();
      }

      function tampilkanModeBuat() {
        document.getElementById('pilihanNota').style.display = 'none';
        document.getElementById('modeBaca').style.display = 'none';
        document.getElementById('modeBuat').style.display = 'block';
      }

      function kembaliKePilihanNota() {
        tampilkanPilihanAwal();
      }

      // === LOGIN ===
      function login() {
        const u = document.getElementById("username").value.trim();
        const p = document.getElementById("password").value;
        const valid = { andi: "1981", risman: "sahrul", anto: "afzal" };
        if (valid[u] === p) {
          currentUser = u;
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("app").style.display = "block";
          if (u !== "andi") {
            document.getElementById("headerTitle").textContent = "Pembukuan Voucher (Pengguna)";
          }
          loadActivePeriodeSetting();
        } else {
          document.getElementById("loginError").textContent = "Username atau password salah";
        }
      }

      function logout() {
        if (transaksiListener) {
          transaksiListener();
          transaksiListener = null;
        }
        currentUser = null;
        currentPeriode = null;
        globalActivePeriode = null;
        agenCache = {};
        document.getElementById("loginScreen").style.display = "block";
        document.getElementById("app").style.display = "none";
        document.getElementById("menuUtama").style.display = "none";
        tampilkanPilihanAwal();
      }

      // === FUNGSI PERIODE & DATA ===
      function loadActivePeriodeSetting() {
        db.ref("settings/active_periode").once("value", (snap) => {
          globalActivePeriode = snap.val() || null;
          loadPeriodeList();
        });
      }

      function loadPeriodeList() {
        db.ref("periode_list").once("value", (snap) => {
          const list = snap.val() || [];
          const sel = document.getElementById("periodeSelect");
          sel.innerHTML = "";
          
          document.getElementById("btnTambahPeriode").style.display = (currentUser === "andi") ? "inline-block" : "none";

          if (list.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "-- Belum ada periode --";
            opt.disabled = true;
            sel.appendChild(opt);
            document.getElementById("btnSetActive").style.display = "none";
            return;
          }

          let sortedList;
          if (currentUser === "andi" && globalActivePeriode && list.includes(globalActivePeriode)) {
            const others = list.filter(p => p !== globalActivePeriode).map(Number).sort((a, b) => a - b).map(String);
            sortedList = [globalActivePeriode, ...others];
          } else {
            sortedList = list.map(Number).sort((a, b) => a - b).map(String);
          }

          sortedList.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            if (currentUser === "andi") {
              opt.textContent = p + (p === globalActivePeriode ? " (Aktif)" : "");
              opt.disabled = false;
            } else {
              if (p === globalActivePeriode) {
                opt.textContent = p + " (Aktif)";
                opt.disabled = false;
              } else {
                opt.textContent = p + " üîí ";
                opt.disabled = true;
              }
            }
            sel.appendChild(opt);
          });

          let periodeToSelect = "";
          if (currentUser === "andi") {
            periodeToSelect = localStorage.getItem("last_periode") || globalActivePeriode || sortedList[0];
            if (!sortedList.includes(periodeToSelect)) {
              periodeToSelect = globalActivePeriode || sortedList[0];
            }
            document.getElementById("btnSetActive").style.display = "inline-block";
          } else {
            periodeToSelect = globalActivePeriode || sortedList[0];
          }

          if (sortedList.includes(periodeToSelect)) {
            sel.value = periodeToSelect;
            currentPeriode = periodeToSelect;
            loadPeriode();
          } else {
            sel.value = "";
            currentPeriode = null;
            document.getElementById("btnSetActive").style.display = "none";
          }
        });
      }

      function setActivePeriode() {
        if (currentUser !== "andi") return;
        const selected = document.getElementById("periodeSelect").value;
        if (!selected) return alert("Pilih periode dulu!");
        db.ref("settings/active_periode").set(selected).then(() => {
          globalActivePeriode = selected;
          alert(`Periode ${selected} sekarang aktif untuk pengguna.`);
          loadPeriodeList();
        }).catch(err => {
          alert("Gagal menetapkan periode aktif: " + err.message);
        });
      }

      function tambahPeriode() {
        if (currentUser !== "andi") return;
        const p = prompt("Masukkan periode (angka, contoh: 202510):");
        if (!p || isNaN(p)) return;
        db.ref("periode_list").once("value", (snap) => {
          const list = snap.val() || [];
          if (!list.includes(p)) {
            list.push(p);
            db.ref("periode_list").set(list).then(() => {
              return db.ref(`data/${p}/agen`).set(AGEN_DEFAULT);
            }).then(() => {
              alert(`Periode ${p} berhasil dibuat.`);
              loadPeriodeList();
            }).catch(err => {
              alert("Gagal membuat periode: " + err.message);
            });
          } else {
            alert("Periode sudah ada!");
          }
        });
      }

      function backupData() {
        if (!currentPeriode) return alert("Pilih periode dulu!");
        db.ref(`data/${currentPeriode}`).once("value", (snap) => {
          const data = snap.val();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `backup_periode_${currentPeriode}.json`;
          a.click();
          URL.revokeObjectURL(url);
        });
      }

      function loadPeriode() {
        currentPeriode = document.getElementById("periodeSelect").value;
        if (!currentPeriode) {
          document.querySelectorAll("#sectionTransaksi input, #sectionTransaksi select").forEach(el => el.disabled = true);
          document.querySelectorAll("#sectionTransaksi button[onclick*='simpanTransaksi']").forEach(btn => btn.style.display = "none");
          return;
        }

        const isActive = (currentPeriode === globalActivePeriode);
        const isEditable = (currentUser === "andi") || (isActive && currentUser !== "andi");

        const transaksiInputs = [
          "agenAmbil", "tglAmbil", "v3Ambil", "v5Ambil",
          "agenSetor", "tglSetor", "nominalSetor",
          "tglTf", "jumlahTf"
        ];

        transaksiInputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = !isEditable;
        });

        const simpanButtons = document.querySelectorAll("#sectionTransaksi button[onclick*='simpanTransaksi']");
        simpanButtons.forEach(btn => {
          btn.style.display = isEditable ? "inline-block" : "none";
        });

        db.ref(`data/${currentPeriode}/stok`).once("value", s => {
          const stok = s.val() || { v3: 0, v5: 0 };
          if (currentUser === "andi") {
            document.getElementById("cellStokV3").innerHTML = `<input type="number" id="stokV3" min="0" value="${stok.v3}" />`;
            document.getElementById("cellStokV5").innerHTML = `<input type="number" id="stokV5" min="0" value="${stok.v5}" />`;
            document.getElementById("btnSimpanStok").style.display = "inline-block";
          } else {
            document.getElementById("cellStokV3").textContent = stok.v3;
            document.getElementById("cellStokV5").textContent = stok.v5;
            document.getElementById("cellStokV3").className = "readonly-cell";
            document.getElementById("cellStokV5").className = "readonly-cell";
            document.getElementById("btnSimpanStok").style.display = "none";
          }
        });

        db.ref(`data/${currentPeriode}/agen`).once("value", (snap) => {
          agenCache = snap.val() || {};
          isiDropdownAgen();
          loadAllData();
        });
      }

      function isiDropdownAgen() {
        const agenList = Object.entries(agenCache).map(([id, nama]) => ({ id, nama }));
        ["agenAmbil", "agenSetor"].forEach(id => {
          const sel = document.getElementById(id);
          sel.innerHTML = '<option value="">-- Pilih Agen --</option>';
          agenList.forEach(a => {
            const opt = document.createElement("option");
            opt.value = a.id;
            opt.textContent = a.nama;
            sel.appendChild(opt);
          });
        });
      }

      function simpanStok() {
        if (currentUser !== "andi") return;
        const v3 = parseInt(document.getElementById("stokV3").value) || 0;
        const v5 = parseInt(document.getElementById("stokV5").value) || 0;
        db.ref(`data/${currentPeriode}/stok`).set({ v3, v5 }).then(() => {
          loadAllData();
        });
      }

      // === NOTA ===
      function simpanCatatanBaru() {
        if (!currentUser) {
          alert("Anda belum login.");
          return;
        }
        if (!globalActivePeriode) {
          alert("Belum ada periode aktif. Catatan tidak bisa disimpan.");
          return;
        }
        const text = document.getElementById("inputCatatanBaru").value.trim();
        if (!text) {
          alert("Catatan tidak boleh kosong.");
          return;
        }

        const now = new Date();
        db.ref(`data/${globalActivePeriode}/catatan`).push({
          user: currentUser,
          text: text,
          timestamp: now.getTime(),
          dateDisplay: now.toLocaleString("id-ID")
        }).then(() => {
          alert("Catatan berhasil disimpan.");
          document.getElementById("inputCatatanBaru").value = "";
          tampilkanModeBaca();
        }).catch(err => {
          console.error(err);
          alert("Gagal menyimpan catatan.");
        });
      }

      function loadCatatan() {
        if (!globalActivePeriode) {
          document.getElementById("daftarCatatan").innerHTML = "<p>Belum ada periode aktif.</p>";
          return;
        }

        const container = document.getElementById("daftarCatatan");
        container.innerHTML = "<p>Memuat catatan...</p>";
        db.ref(`data/${globalActivePeriode}/catatan`)
          .orderByChild("timestamp")
          .once("value", (snapshot) => {
            container.innerHTML = "";
            const data = snapshot.val();
            if (!data) {
              container.innerHTML = "<p>Belum ada catatan.</p>";
              return;
            }
            const entries = Object.values(data);
            entries.sort((a, b) => b.timestamp - a.timestamp);
            entries.forEach(entry => {
              const div = document.createElement("div");
              div.className = "catatan-item";
              div.innerHTML = `
                <div class="catatan-header">
                  Oleh: <strong>${entry.user}</strong> ‚Äî ${entry.dateDisplay}
                </div>
                <div class="catatan-text">${entry.text}</div>
              `;
              container.appendChild(div);
            });
          });
      }

      // === TRANSAKSI ===
      function simpanAgen() {
        let id = document.getElementById("modalId").value.trim();
        const nama = document.getElementById("modalNama").value.trim();
        if (!id || !nama) return alert("ID dan Nama harus diisi");
        id = id.padStart(3, "0");
        db.ref(`data/${currentPeriode}/agen/${id}`).set(nama).then(() => {
          agenCache[id] = nama;
          isiDropdownAgen();
          tutupModal();
        });
      }

      function tutupModal() {
        document.getElementById("modalAgen").style.display = "none";
      }

      function simpanTransaksi(jenis) {
        let data = { jenis };
        if (jenis === "ambil") {
          const agen = document.getElementById("agenAmbil").value;
          const v3 = parseInt(document.getElementById("v3Ambil").value) || 0;
          const v5 = parseInt(document.getElementById("v5Ambil").value) || 0;
          const tgl = document.getElementById("tglAmbil").value || new Date().toISOString().split("T")[0];
          if (!agen || (v3 === 0 && v5 === 0)) return alert("Pilih agen dan isi V3/V5");
          data.agen = agen;
          data.v3 = v3;
          data.v5 = v5;
          data.tgl = tgl;
          data.nominal = v3 * HARGA_V3_AGEN + v5 * HARGA_V5_AGEN;
        } else if (jenis === "setor") {
          const agen = document.getElementById("agenSetor").value;
          const nominal = parseInt(document.getElementById("nominalSetor").value) || 0;
          const tgl = document.getElementById("tglSetor").value || new Date().toISOString().split("T")[0];
          if (!agen || nominal <= 0) return alert("Pilih agen dan isi nominal");
          data.agen = agen;
          data.tgl = tgl;
          data.nominal = nominal;
        } else if (jenis === "tf") {
          const tglTf = document.getElementById("tglTf").value;
          const jumlahTf = parseInt(document.getElementById("jumlahTf").value) || 0;
          if (!tglTf || jumlahTf <= 0) return alert("Isi tanggal dan jumlah transfer");
          data.tgl = tglTf;
          data.nominal = jumlahTf;
        } else {
          return;
        }
        db.ref(`data/${currentPeriode}/transaksi`).push(data).then(() => {
          resetFormTransaksi();
        });
      }

      function resetFormTransaksi() {
        ["v3Ambil", "v5Ambil", "nominalSetor", "jumlahTf"].forEach(id => {
          document.getElementById(id).value = "";
        });
        document.getElementById("tglTf").value = "";
      }

      // ‚úÖ REALTIME + CLEANUP
      function loadAllData() {
        if (!currentPeriode) return;

        if (transaksiListener) {
          transaksiListener();
        }

        const ref = db.ref(`data/${currentPeriode}/transaksi`);
        const callback = (snap) => {
          const trans = snap.val() || {};
          const tbodyR = document.getElementById("tbodyRiwayat");
          const tbodyA = document.getElementById("tbodyRekapAgen");
          tbodyR.innerHTML = "";
          tbodyA.innerHTML = "";
          const agenMap = {};
          let totalPengambilan = 0;
          let totalSetoran = 0;
          let totalTf = 0;
          let totalV3 = 0, totalV5 = 0;

          Object.entries(trans).forEach(([key, t]) => {
            const ambil = t.jenis === "ambil";
            const setor = t.jenis === "setor";
            const tf = t.jenis === "tf";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${t.tgl}</td>
              <td>${tf ? "TRANSFER" : (agenCache[t.agen] || t.agen)}</td>
              <td>${ambil ? "BENAR" : "X"}</td>
              <td>${setor ? "BENAR" : "X"}</td>
              <td>${ambil ? t.v3 : ""}</td>
              <td>${ambil ? t.v5 : ""}</td>
              <td>Rp. ${t.nominal.toLocaleString()}</td>
              <td>
                ${currentUser === "andi" && !tf ?
                  `<button onclick="editTransaksi('${key}', ${JSON.stringify(t).replace(/"/g, '&quot;')})">Edit</button>
                   <button class="danger" onclick="hapusTransaksi('${key}')">Hapus</button>` : 
                  (tf ? `<button class="danger" onclick="hapusTransaksi('${key}')">Hapus</button>` : "")}
              </td>
            `;
            tbodyR.appendChild(tr);
            if (ambil) {
              totalPengambilan += t.nominal;
              totalV3 += t.v3;
              totalV5 += t.v5;
              if (!agenMap[t.agen]) agenMap[t.agen] = { ambil: 0, setor: 0 };
              agenMap[t.agen].ambil += t.nominal;
            }
            if (setor) {
              totalSetoran += t.nominal;
              if (!agenMap[t.agen]) agenMap[t.agen] = { ambil: 0, setor: 0 };
              agenMap[t.agen].setor += t.nominal;
            }
            if (tf) {
              totalTf += t.nominal;
            }
          });

          Object.entries(agenMap).forEach(([id, data]) => {
            const nama = agenCache[id] || id;
            const utang = data.ambil - data.setor;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${nama}</td>
              <td>Rp. ${data.ambil.toLocaleString()}</td>
              <td>Rp. ${data.setor.toLocaleString()}</td>
              <td style="color: ${utang > 0 ? 'red' : 'green'};">Rp. ${utang.toLocaleString()}</td>
            `;
            tbodyA.appendChild(tr);
          });

          document.getElementById("totalAmbilFooter").textContent = `Rp. ${totalPengambilan.toLocaleString()}`;
          document.getElementById("totalSetorFooter").textContent = `Rp. ${totalSetoran.toLocaleString()}`;
          document.getElementById("dropV3").textContent = totalV3;
          document.getElementById("dropV5").textContent = totalV5;

          db.ref(`data/${currentPeriode}/stok`).once("value", s => {
            const stok = s.val() || { v3: 0, v5: 0 };
            const sisaV3 = Math.max(0, stok.v3 - totalV3);
            const sisaV5 = Math.max(0, stok.v5 - totalV5);
            document.getElementById("sisaV3").textContent = sisaV3;
            document.getElementById("sisaV5").textContent = sisaV5;

            const totalYangBelumDiterima = Math.max(0, totalPengambilan - totalSetoran);
            document.getElementById("rek2").textContent = totalYangBelumDiterima.toLocaleString();
            document.getElementById("rek3").textContent = totalSetoran.toLocaleString();

            const totalStokAwal = (stok.v3 * 2550) + (stok.v5 * 4250);
            document.getElementById("rek1").textContent = totalStokAwal.toLocaleString();

            const totalGlobal = stok.v3 * HARGA_V3_GLOBAL + stok.v5 * HARGA_V5_GLOBAL;
            document.getElementById("rek4").textContent = totalGlobal.toLocaleString();
            document.getElementById("rek5").textContent = totalTf.toLocaleString();
            document.getElementById("rek6").textContent = (totalGlobal - totalTf).toLocaleString();

            const danaBarang = (sisaV3 * 2550) + (sisaV5 * 4250);
            document.getElementById("rek7").textContent = danaBarang.toLocaleString();
          });
        };

        ref.on("value", callback);
        transaksiListener = () => ref.off("value", callback);
      }

      function editTransaksi(key, dataStr) {
        try {
          const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
          if (confirm("Edit transaksi ini?")) {
            db.ref(`data/${currentPeriode}/transaksi/${key}`).remove().then(() => {
              if (data.jenis === "ambil") {
                document.getElementById("agenAmbil").value = data.agen;
                document.getElementById("v3Ambil").value = data.v3;
                document.getElementById("v5Ambil").value = data.v5;
                document.getElementById("tglAmbil").value = data.tgl;
              } else if (data.jenis === "setor") {
                document.getElementById("agenSetor").value = data.agen;
                document.getElementById("nominalSetor").value = data.nominal;
                document.getElementById("tglSetor").value = data.tgl;
              }
              simpanTransaksi(data.jenis);
            });
          }
        } catch (e) {
          alert("Gagal memproses edit.");
        }
      }

      function hapusTransaksi(key) {
        if (confirm("Hapus transaksi ini?")) {
          db.ref(`data/${currentPeriode}/transaksi/${key}`).remove();
        }
      }
    </script>
</body>
</html>




